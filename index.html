<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>HoopsHype Overpaid / Underpaid Dashboard</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#ffffff;--text:#111;--muted:#666;--border:#e5e7eb;--pill:#f3f4f6}
    *{box-sizing:border-box}
    body{font-family:Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";margin:0;background:var(--bg);color:var(--text)}
    .container{max-width:1100px;margin:24px auto;padding:0 16px}
    h1{font-size:22px;margin:0 0 12px}
    .controls{display:grid;grid-template-columns:repeat(12,1fr);gap:8px;align-items:end;margin:12px 0 16px}
    .control{grid-column:span 3}
    .control label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    select,input{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;background:#fff;font-size:14px}
    button{padding:10px 14px;border:1px solid var(--border);background:#111;color:#fff;border-radius:10px;cursor:pointer;font-weight:600}
    button.secondary{background:#fff;color:#111}
    .row{display:flex;gap:8px;align-items:center}
    .tags{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}
    .tag{background:var(--pill);padding:6px 10px;border-radius:999px;font-size:12px}
    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-size:12px;text-align:left;color:#555;padding:6px 8px}
    tbody tr{background:#fff;border:1px solid var(--border)}
    tbody td{padding:10px 8px;border-bottom:1px solid var(--border);font-size:14px}
    tbody tr:last-child td{border-bottom:none}
    .right{text-align:right}
    .muted{color:var(--muted)}
    .link{color:#0b62ff;text-decoration:none}
    .pill{padding:2px 8px;border-radius:999px;background:#eef2ff;color:#1e40af;font-size:12px}
    .clickable{cursor:pointer}
    .footer{margin:12px 0;color:#777;font-size:12px}
    .sticky-bar{position:sticky;top:0;background:var(--bg);padding:10px 0;z-index:5;border-bottom:1px solid var(--border)}
    .notice{font-size:12px;color:#555;margin:6px 0 0}
    .totals{font-weight:700}
    .rankrow{background:#fafafa}
    .chip{font-size:11px;padding:4px 8px;border:1px solid var(--border);border-radius:999px}
    .btn-clear{border-color:#d1d5db}
    .hidden{display:none}
  </style>
</head>
<body>
<div class="container" id="app">
  <div class="sticky-bar">
    <h1>Overpaid / Underpaid — 1990-91 to 2024-25</h1>
    <div class="controls">
      <div class="control" style="grid-column:span 3">
        <label>From season</label>
        <select id="fromSeason"></select>
      </div>
      <div class="control" style="grid-column:span 3">
        <label>To season</label>
        <select id="toSeason"></select>
      </div>
      <div class="control" style="grid-column:span 3">
        <label>Team</label>
        <select id="teamSelect">
          <option value="">All teams</option>
        </select>
      </div>
      <div class="control" style="grid-column:span 3">
        <label>Player</label>
        <input id="playerInput" placeholder="Type a player..." />
      </div>
      <div class="control" style="grid-column:span 12;display:flex;gap:8px;justify-content:flex-end">
        <button class="secondary btn-clear" id="clearBtn">Clear</button>
        <button id="applyBtn">Apply</button>
      </div>
    </div>
  </div>

  <div id="chips" class="tags"></div>

  <div id="viewTitle" class="row" style="justify-content:space-between;margin:10px 0 6px">
    <div><span id="viewLabel" class="pill">Season 2024-25</span> <span class="muted" id="subtitle">Ranking: most underpaid → most overpaid</span></div>
    <div class="row hidden" id="playerMeta">
      <span class="chip" id="rankChip"></span>
      <span class="chip" id="gamesChip"></span>
    </div>
  </div>

  <table>
    <thead>
      <tr>
        <th>#</th>
        <th>Player</th>
        <th>Season</th>
        <th>Team(s)</th>
        <th class="right">Salary</th>
        <th class="right">Real Value</th>
        <th class="right">Difference</th>
        <th class="right">RV / Salary</th>
      </tr>
    </thead>
    <tbody id="tbody"></tbody>
  </table>
  <div class="footer" id="footnote">Click a player to see their seasons. Click a season to see that season's full ranking. Click a team to see that team.</div>
</div>

<!-- libs: lightweight + browser friendly -->
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<script>
// ====== UTIL ======
const seasonOrder = (s)=>{
  // '1990-91' → 1990; handle malformed
  if(!s || typeof s !== 'string') return -1
  const m = s.match(/^(\d{4})-\d{2}$/)
  return m? parseInt(m[1],10) : -1
}
const moneyToNum = (x)=>{
  if(x==null) return 0
  if(typeof x === 'number') return x
  return parseFloat(String(x).replace(/[$,]/g,'').trim())||0
}
const numToMoney = (n)=>{
  return new Intl.NumberFormat('en-US',{style:'currency',currency:'USD',maximumFractionDigits:0}).format(n)
}
const ratioColor = (ratio)=>{
  // Map ratio (0 → red, 1 → neutral, 2+ → green). Clamp 0..2.5
  const r = Math.max(0, Math.min(2.5, ratio||0))
  // interpolate 0 (red) to 1 (yellow) to 2.5 (green)
  let R,G
  if(r<=1){ // red→yellow
    const t=r/1
    R=255
    G=Math.round(0 + t*215)
  }else{ // yellow→green
    const t=(r-1)/(1.5)
    R=Math.round(255 - t*255)
    G=215
  }
  return `rgb(${R},${G},120)`
}
const slug = (name)=> String(name||'').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'')
const hhPlayerUrl = (name)=> `https://www.hoopshype.com/player/${slug(name)}/`
const hhTeamUrl = (abbr)=> `https://www.hoopshype.com/team/${String(abbr||'').toLowerCase()}/`

// ====== STATE ======
let RAW=[], PLAYERS=[], TEAMS=[], SEASONS=[]
let current = { from:'1990-91', to:'2024-25', team:'', player:'', mode:'season' }

// ====== LOAD CSV ======
// Expect a UTF-8 CSV at ./data/real_value.csv with columns:
// YEAR, PLAYER, DIFF, REAL VALUE, SALARY, Games played, [U/O], [Team(s)]
Papa.parse('./data/real_value.csv', {
  header: true,
  download: true,
  skipEmptyLines: true,
  complete: (res)=>{
    const rows = res.data
      .filter(r=>r['YEAR'] && /\d{4}-\d{2}/.test(r['YEAR']))
      .map(r=>({
        year: String(r['YEAR']).trim(),
        player: String(r['PLAYER']).trim(),
        player_hh: String(r['PLAYER HH']||r['PLAYER']).trim(),
        diff: moneyToNum(r['DIFF']),
        real: moneyToNum(r['REAL VALUE']),
        salary: moneyToNum(r['SALARY']),
        games: Number(r['Games played']||0),
        uo: (r['Unnamed: 8']||'').trim(),
        teams: String(r['Unnamed: 9']||'').trim() // may be comma-separated
      }))
    RAW = rows
    SEASONS = Array.from(new Set(RAW.map(r=>r.year))).sort((a,b)=>seasonOrder(a)-seasonOrder(b))
    PLAYERS = Array.from(new Set(RAW.map(r=>r.player))).sort()
    // Team codes can be comma-sep; split & trim
    const teamSet = new Set()
    RAW.forEach(r=>{
      String(r.teams||'').split(',').map(t=>t.trim()).filter(Boolean).forEach(t=>teamSet.add(t))
    })
    TEAMS = Array.from(teamSet).sort()

    initControls()
    // default view: 2024-25 season ranking
    current.from = '2024-25'; current.to='2024-25'; current.mode='season';
    render()
  }
})

function initControls(){
  const fromSel=document.getElementById('fromSeason')
  const toSel=document.getElementById('toSeason')
  fromSel.innerHTML=''; toSel.innerHTML=''
  SEASONS.forEach(s=>{
    const o1=document.createElement('option'); o1.value=s; o1.textContent=s; fromSel.appendChild(o1)
    const o2=document.createElement('option'); o2.value=s; o2.textContent=s; toSel.appendChild(o2)
  })
  fromSel.value=current.from||SEASONS[0]
  toSel.value=current.to||SEASONS[SEASONS.length-1]

  const teamSel=document.getElementById('teamSelect')
  TEAMS.forEach(t=>{ const o=document.createElement('option'); o.value=t; o.textContent=t; teamSel.appendChild(o) })

  document.getElementById('applyBtn').onclick=()=>{
    current.from = fromSel.value
    current.to = toSel.value
    current.team = teamSel.value
    current.player = document.getElementById('playerInput').value.trim()
    // decide mode priority: player > team > season-range
    if(current.player){ current.mode='player' }
    else if(current.team){ current.mode='team' }
    else if(current.from===current.to){ current.mode='season' }
    else { current.mode='range' }
    render()
  }
  document.getElementById('clearBtn').onclick=()=>{
    current = { from: SEASONS[0], to: SEASONS[SEASONS.length-1], team:'', player:'', mode:'season' }
    fromSel.value='2024-25' in SEASONS? '2024-25' : SEASONS[SEASONS.length-1]
    toSel.value=fromSel.value
    teamSel.value=''
    document.getElementById('playerInput').value=''
    current.from=fromSel.value; current.to=toSel.value
    render()
  }
}

// ====== RENDERING ======
function render(){
  const tbody=document.getElementById('tbody'); tbody.innerHTML=''
  const viewLabel=document.getElementById('viewLabel')
  const subtitle=document.getElementById('subtitle')
  const chips=document.getElementById('chips'); chips.innerHTML=''
  document.getElementById('playerMeta').classList.add('hidden')

  // Filter base rows by season range
  const fromY = seasonOrder(current.from), toY=seasonOrder(current.to)
  let rows = RAW.filter(r=>{
    const y=seasonOrder(r.year)
    return y>=fromY && y<=toY
  })

  // team filter: include player-season if any of its teams match the selection
  if(current.team){
    rows = rows.filter(r=> String(r.teams||'').split(',').map(t=>t.trim()).includes(current.team))
    chips.appendChild(chip(`Team: ${current.team}`, ()=>{ current.team=''; render() }))
  }
  
  // Switch on mode
  if(current.mode==='player' && current.player){
    // Player detail: seasons chronologically, plus totals and all-time rank
    const p = current.player
    const pres = RAW.filter(r=> r.player.toLowerCase()===p.toLowerCase())
                    .sort((a,b)=> seasonOrder(a.year)-seasonOrder(b.year))
    viewLabel.textContent = `Player: ${p}`
    subtitle.textContent = 'Seasons (chronological) — click a season to open that season view'
    chips.appendChild(chip(`Player: ${p}`, ()=>{ current.player=''; current.mode = current.team? 'team' : (current.from===current.to?'season':'range'); render() }))

    // table rows
    let rankRows = []
    pres.forEach((r,i)=>{
      const ratio = r.salary>0? (r.real/r.salary): 0
      const tr = rowTemplate({
        idx: i+1,
        player: r.player,
        playerClick: ()=>{}, // keep name inert here
        playerUrl: hhPlayerUrl(r.player),
        season: r.year,
        seasonClick: ()=>{ current.from=r.year; current.to=r.year; current.team=''; current.player=''; current.mode='season'; render() },
        teams: r.teams,
        teamClick: (t)=>{ current.team=t; current.from=r.year; current.to=r.year; current.player=''; current.mode='team'; render() },
        salary: r.salary,
        real: r.real,
        diff: r.diff,
        ratio
      })
      tbody.appendChild(tr)
      rankRows.push(r)
    })

    // totals row
    const totalSalary = pres.reduce((a,b)=>a+b.salary,0)
    const totalReal = pres.reduce((a,b)=>a+b.real,0)
    const totalDiff = pres.reduce((a,b)=>a+b.diff,0)
    const trTot = rowTemplate({
      idx: '', player: 'Totals', season: '', teams:'', salary: totalSalary, real: totalReal, diff: totalDiff, ratio: totalSalary>0? totalReal/totalSalary:0,
      asTotals:true
    })
    tbody.appendChild(trTot)

    // all-time rank by cumulative DIFF
    const byPlayer = groupBy(RAW, r=>r.player)
    const ranks = Object.entries(byPlayer).map(([name,rows])=>({
      player: name,
      totalDiff: rows.reduce((a,b)=>a+b.diff,0),
      totalSalary: rows.reduce((a,b)=>a+b.salary,0),
      totalReal: rows.reduce((a,b)=>a+b.real,0)
    })).sort((a,b)=> b.totalDiff - a.totalDiff)
    const N = ranks.length
    const idxRank = ranks.findIndex(x=>x.player.toLowerCase()===p.toLowerCase())
    document.getElementById('playerMeta').classList.remove('hidden')
    document.getElementById('rankChip').textContent = `All-time rank: ${idxRank+1} of ${N}`
    document.getElementById('gamesChip').textContent = `Seasons: ${pres.length}`

    const trRank = document.createElement('tr'); trRank.className='rankrow'
    trRank.innerHTML = `<td></td><td colspan="6"><span class="muted">All-time ranking by total Difference since 1990-91</span></td><td class="right">#${idxRank+1} / ${N}</td>`
    tbody.appendChild(trRank)

  } else if(current.mode==='team' && current.team){
    // Team view. If a single season → list that season players. If range → aggregate per player within team & range
    const label = (current.from===current.to)? `Team: ${current.team} — ${current.from}` : `Team: ${current.team} — ${current.from} to ${current.to}`
    viewLabel.textContent = label
    subtitle.textContent = (current.from===current.to)? 'Players ranked: most underpaid → most overpaid' : 'Players totals within selected seasons — ranked by total Difference'

    const teamRows = rows.filter(r=> String(r.teams||'').split(',').map(t=>t.trim()).includes(current.team))

    if(current.from===current.to){
      // show player-seasons for that year
      const ordered = teamRows.sort((a,b)=> b.diff - a.diff)
      ordered.forEach((r,i)=>{
        const tr = rowTemplate({
          idx:i+1,
          player:r.player,
          playerClick: ()=>{ current.player=r.player; current.mode='player'; render() },
          playerUrl: hhPlayerUrl(r.player),
          season:r.year,
          seasonClick: ()=>{},
          teams:r.teams,
          teamClick:(t)=>{ current.team=t; render() },
          salary:r.salary, real:r.real, diff:r.diff, ratio: r.salary>0? r.real/r.salary:0
        })
        tbody.appendChild(tr)
      })
    } else {
      // aggregate by player across seasons
      const g = groupBy(teamRows, r=>r.player)
      const agg = Object.entries(g).map(([name,rows])=>({
        player:name,
        seasons:new Set(rows.map(r=>r.year)).size,
        years:Array.from(new Set(rows.map(r=>r.year))).sort((a,b)=>seasonOrder(a)-seasonOrder(b)).join(', '),
        teams: Array.from(new Set(rows.flatMap(r=>String(r.teams||'').split(',').map(t=>t.trim())))).join(', '),
        salary: rows.reduce((a,b)=>a+b.salary,0),
        real: rows.reduce((a,b)=>a+b.real,0),
        diff: rows.reduce((a,b)=>a+b.diff,0)
      })).sort((a,b)=> b.diff - a.diff)

      agg.forEach((r,i)=>{
        const tr = rowTemplate({
          idx:i+1, player:r.player, playerClick: ()=>{ current.player=r.player; current.mode='player'; render() }, playerUrl: hhPlayerUrl(r.player),
          season: r.seasons>1? `${r.seasons} seasons` : r.years,
          seasonClick: ()=>{}, teams: r.teams, teamClick:(t)=>{ current.team=t; render() },
          salary:r.salary, real:r.real, diff:r.diff, ratio: r.salary>0? r.real/r.salary:0
        })
        tbody.appendChild(tr)
      })
    }

  } else if(current.mode==='range' && fromY<toY){
    // Range view: totals per player across seasons
    const label = `Seasons: ${current.from} to ${current.to}`
    viewLabel.textContent = label
    subtitle.textContent = 'Players totals across the selected seasons — ranked by total Difference'
    const g = groupBy(rows, r=>r.player)
    const agg = Object.entries(g).map(([name,rows])=>({
      player:name,
      seasons:new Set(rows.map(r=>r.year)).size,
      teams: Array.from(new Set(rows.flatMap(r=>String(r.teams||'').split(',').map(t=>t.trim())))).join(', '),
      salary: rows.reduce((a,b)=>a+b.salary,0),
      real: rows.reduce((a,b)=>a+b.real,0),
      diff: rows.reduce((a,b)=>a+b.diff,0)
    })).sort((a,b)=> b.diff - a.diff)

    agg.forEach((r,i)=>{
      const tr = rowTemplate({
        idx:i+1, player:r.player, playerClick: ()=>{ current.player=r.player; current.mode='player'; render() }, playerUrl: hhPlayerUrl(r.player),
        season: r.seasons>1? `${r.seasons} seasons` : current.from,
        seasonClick: ()=>{}, teams: r.teams, teamClick:(t)=>{ current.team=t; render() },
        salary:r.salary, real:r.real, diff:r.diff, ratio: r.salary>0? r.real/r.salary:0
      })
      tbody.appendChild(tr)
    })

  } else {
    // Single-season ranking (default)
    viewLabel.textContent = `Season ${current.from}`
    subtitle.textContent = 'Ranking: most underpaid → most overpaid'
    const one = RAW.filter(r=>r.year===current.from)
                   .sort((a,b)=> b.diff - a.diff)
    one.forEach((r,i)=>{
      const tr = rowTemplate({
        idx:i+1,
        player:r.player,
        playerClick: ()=>{ current.player=r.player; current.mode='player'; render() },
        playerUrl: hhPlayerUrl(r.player),
        season:r.year,
        seasonClick: ()=>{},
        teams:r.teams,
        teamClick:(t)=>{ current.team=t; current.mode='team'; render() },
        salary:r.salary,
        real:r.real,
        diff:r.diff,
        ratio: r.salary>0? (r.real/r.salary) : 0
      })
      tbody.appendChild(tr)
    })
  }
}

function chip(text,onClick){
  const s=document.createElement('span'); s.className='tag clickable'; s.textContent=text; s.onclick=onClick; return s
}

function groupBy(arr, keyFn){
  const m={}
  arr.forEach(it=>{ const k=keyFn(it); (m[k]||(m[k]=[])).push(it) })
  return m
}

function rowTemplate(opts){
  const { idx, player, playerClick, playerUrl, season, seasonClick, teams, teamClick, salary, real, diff, ratio, asTotals } = opts
  const tr=document.createElement('tr')
  if(asTotals) tr.className='totals'
  const tdIdx=`<td class="right">${idx!==undefined?idx:''}</td>`
  const tdPlayer = asTotals
    ? `<td>Totals</td>`
    : `<td><a class="link clickable" title="Open player view" href="javascript:void(0)" onclick="window.__onPlayer('${encodeURIComponent(player)}')">${player}</a> <a class="muted" href="${playerUrl}" target="_blank" rel="noopener">↗</a></td>`
  const tdSeason = season
    ? `<td><a class="link clickable" href="javascript:void(0)" onclick="window.__onSeason('${season}')">${season}</a></td>`
    : `<td></td>`
  const teamPieces = String(teams||'').split(',').map(t=>t.trim()).filter(Boolean).map(t=>`<a class="link" href="javascript:void(0)" onclick="window.__onTeam('${t}')">${t}</a>`)
  const tdTeams = `<td>${teamPieces.join(', ')}</td>`
  const tdSalary = `<td class="right">${numToMoney(salary)}</td>`
  const tdReal = `<td class="right">${numToMoney(real)}</td>`
  const color = ratioColor(ratio)
  const tdDiff = `<td class="right" style="background:${color};color:#000;font-weight:600">${numToMoney(diff)}</td>`
  const tdRatio = `<td class="right">${(ratio||0).toFixed(2)}×</td>`
  tr.innerHTML = tdIdx + tdPlayer + tdSeason + tdTeams + tdSalary + tdReal + tdDiff + tdRatio
  return tr
}

// global click helpers used in inline handlers
window.__onPlayer = (enc)=>{ current.player = decodeURIComponent(enc); current.mode='player'; render() }
window.__onSeason = (s)=>{ current.from=s; current.to=s; current.team=''; current.player=''; current.mode='season'; render() }
window.__onTeam = (t)=>{ current.team=t; current.mode='team'; render() }
</script>
</body>
</html>
